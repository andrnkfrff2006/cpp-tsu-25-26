name: Task 06 CI

on:
  push:
    branches: [ "task-06" ]
  pull_request_target:
    branches: [ "task-06" ]
  workflow_dispatch:

jobs:
  build-and-run:
    name: Build and Run (Makefile)
    runs-on: ubuntu-latest
    steps:
      - name: Check out base repo main
        uses: actions/checkout@v4
        with:
          repository: ${{ github.event.pull_request.base.repo.full_name || github.repository }}
          ref: main
          path: base_main
          fetch-depth: 1

      - name: Check out PR head
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.pull_request.head.sha }}
          path: pr_head
          fetch-depth: 1

      - name: Copy geometry.hpp from PR into base
        run: |
          set -eu
          if [ ! -f pr_head/geometry.hpp ]; then
            echo "geometry.hpp not found in PR head checkout" >&2
            exit 1
          fi
          cp -f pr_head/geometry.hpp base_main/geometry.hpp

      - name: Show compiler version
        run: g++ --version

      - name: Build (make all)
        run: |
          set -eu
          make -C base_main all

      - name: Run (make run) and capture score
        id: run_tests
        run: |
          set -eu
          # Run and capture output
          make -C base_main run | tee base_main/run.log
          SUMMARY_LINES=$(tail -n2 base_main/run.log || true)
          SCORE_LINE=$(echo "$SUMMARY_LINES" | grep -m1 'Score:' || true)
          echo "summary=${SUMMARY_LINES}" >> "$GITHUB_OUTPUT"
          echo "score=${SCORE_LINE}" >> "$GITHUB_OUTPUT"
          {
            echo "### Result"
            echo
            if [ -n "$SUMMARY_LINES" ]; then
              echo "$SUMMARY_LINES"
            else
              echo "Summary lines not found."
            fi
          } >> "$GITHUB_STEP_SUMMARY"

      - name: Expose score as job summary and annotations
        if: always()
        run: |
          set -eu
          echo "Run finished. See summary above."
